services:
  # 1. FastAPI Backend Service
  backend:
    build:
      context: ./Backend
    env_file:
      - ./Backend/.env
    ports:
      - "8000:8000"
    volumes:
      - ./Backend/app:/app/app
      - ./Backend/alembic:/app/alembic
      - ./Backend/alembic.ini:/app/alembic.ini
      - ./Backend/test_searcher.py:/app/test_searcher.py
      - ./Backend/ranker.py:/app/ranker.py
      - ./Backend/my_database.py:/app/my_database.py
      - ./Backend/searcher_apollo_web.py:/app/searcher_apollo_web.py
      - ./Backend/searcher_apollo_web.py:/app/app/searcher_apollo_web.py
    # CRITICAL FIX: Changed workers (-w) from 4 to 1.
    # With 4 workers per person, 10 people = 40 connections = DB Crash.
    # With 1 worker per person, 20 people = 20 connections = Safe.
    command: gunicorn -w 1 -k uvicorn.workers.UvicornWorker --timeout 120 app.main:app --bind 0.0.0.0:8000
    depends_on:
      - redis

  # 2. React Frontend Service
  frontend:
    build:
      context: ./Frontend
    ports:
      - "5173:5173"
    volumes:
      - ./Frontend:/app
      - node_modules:/app/node_modules
    command: npm run dev -- --host
    depends_on:
      - backend
    # CRITICAL FIX: Tell Docker frontend where the backend is
    environment:
      - VITE_API_TARGET=http://backend:8000

  # 3. Redis Service
  redis:
    image: "redis:7-alpine"
    ports:
      - "6379:6379"

  # 4. Celery Worker Service
  worker:
    build:
      context: ./Backend
    command: celery -A app.worker worker --loglevel=info --concurrency=2
    volumes:
      - ./Backend/app:/app/app
      - ./Backend/test_searcher.py:/app/test_searcher.py
      - ./Backend/ranker.py:/app/ranker.py
      - ./Backend/my_database.py:/app/my_database.py
      - ./Backend/searcher_apollo_web.py:/app/searcher_apollo_web.py
      - ./Backend/searcher_apollo_web.py:/app/app/searcher_apollo_web.py
    env_file:
      - ./Backend/.env
    depends_on:
      - redis
      - backend

volumes:
  node_modules: